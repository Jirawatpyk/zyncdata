# Epic 5 Retrospective — Health Monitoring & Analytics Dashboard

**Date:** 2026-02-08
**Facilitator:** Bob (Scrum Master)
**Epic:** Epic 5 — Health Monitoring & Analytics Dashboard (8 stories)
**Status:** Complete (8/8 stories done)

---

## Team Participants

- Alice (Product Owner)
- Bob (Scrum Master — facilitating)
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- Winston (Architect)
- Jiraw (Project Lead)

---

## Epic Summary & Metrics

### Delivery

- **Stories Completed:** 8/8 (100%)
  - 5-1: Basic Health Check Service & Status Updates
  - 5-2: Failure Detection, Retry Logic & Recovery
  - 5-3: Health Check Data Pruning & Scalability
  - 5-4: Health Monitoring Dashboard
  - 5-5: Real-Time Dashboard Updates (Supabase Realtime)
  - 5-6: Health Check Failure Notifications (Resend)
  - 5-7: Configurable Health Check Settings
  - 5-8: Historical Health Check Data
- **Deferred:** None
- **FRs covered:** FR33-FR41, FR64-FR67 (13 FRs)
- **All stories:** Implemented, code reviewed, fixes applied, marked done

### Quality

- **Test suite growth:** 1309 (Epic 4 baseline) → 1532 (~223 new tests, 17% growth)
- **Test files:** 107 → 135 (~28 new test files)
- **Code review issues found:** ~51 total
  - Story 5-1: 7 issues (0 HIGH)
  - Story 5-2: 7 issues (3 HIGH — client instantiation, JSDoc misleading, AbortController sharing)
  - Story 5-3: 8 issues (2 HIGH — migration rename, pruning COUNT→OFFSET optimization)
  - Story 5-4: 6 issues (1 HIGH — missing server prefetch AnalyticsContent)
  - Story 5-5: 3 issues (0 HIGH, 2 MEDIUM — reconnect timeout, contract test assertion)
  - Story 5-6: 10 issues (1 HIGH — 44px touch target on remove-email button)
  - Story 5-7: 5 issues (0 HIGH, 4 MEDIUM — bg-red-50, duplicate import, malformed JSON 400, misleading enabled)
  - Story 5-8: 5 issues (0 HIGH — OKLCH color fix, CustomDot null check, Zod parse, loading skeleton test, file list count)
- **All issues:** Fixed before marking stories done
- **HIGH severity issues:** 7 total (distributed across 4 stories)
- **Production incidents:** 0
- **Regressions:** 0
- **Peak defect density:** 10 issues/story (5-6) — 50% reduction from Epic 4 peak (20 issues in Story 4-2)

### Business Outcomes

- Complete health monitoring infrastructure: automated cron checks every 5 minutes (Vercel Cron)
- Failure detection with retry logic (exponential backoff + jitter) and configurable thresholds
- Data pruning: PostgreSQL trigger caps at 1000 records/system automatically
- Admin dashboard with summary cards, sortable health table, response time chart
- Real-time dashboard updates via Supabase Realtime `postgres_changes` + 60s polling fallback
- Email notifications (Resend) for offline transitions and recovery events
- Per-system configurable settings: timeout, failure threshold, check interval (stored)
- Historical data with paginated table, status filtering, and response time trend chart

### Technical Infrastructure Established

- 4th Supabase client factory: `service.ts` (synchronous, bypasses RLS for cron/background jobs)
- Vercel Cron with `CRON_SECRET` authentication (`vercel.json` schedule)
- Exponential backoff with full jitter retry logic (`checkSystemHealthWithRetry`)
- PostgreSQL trigger `prune_old_health_checks()` — AFTER INSERT, OFFSET-based pruning
- Inline concurrency limiter `withConcurrencyLimit()` — 5 concurrent, index-preserving
- Supabase Realtime `postgres_changes` subscription — eliminated need for custom WebSocket server
- `useHealthMonitor` hook — debounced cache invalidation, 3-state connection tracking
- Resend email integration — failure + recovery notifications, `escapeHtml()` for XSS prevention
- Recharts lazy-loaded via `next/dynamic({ ssr: false })` — ~45 KB separate chunk
- Health history API with offset-based pagination + status filtering
- Notification settings: singleton config table + admin UI + audit logging

---

## Successes & Strengths

1. **100% story completion (8/8)** — second consecutive epic at 100%, zero scope inflation
2. **Epic 4 retro follow-through: 5/5 actionable items applied**
   - P1 story splitting: ALL 8 stories had `<!-- THRESHOLD CHECK -->` comments. Largest: 10 tasks. Zero exceeded 12-task threshold.
   - P2 `mutateAsync` + try/catch: applied in NotificationSettings (5-6), HealthConfigDialog (5-7). Zero unhandled promise rejection issues.
   - P3 integration contract verification: Stories 5-5, 5-6, 5-7, 5-8 all had explicit `<!-- P3 -->` checkboxes. Zero integration seam failures.
   - D1 flaky test: resolved. Zero timeout issues across Epic 5.
   - D2 `glow-pulse`: accepted, no revisit needed.
3. **Peak defect density cut 50%** — worst story (5-6: 10 issues, 1 HIGH) vs Epic 4 worst (4-2: 20 issues, 5 HIGHs). Story splitting threshold directly contributed.
4. **Excellent architecture decisions:**
   - Supabase Realtime instead of custom WebSocket server (5-5) — zero new dependencies, zero server infrastructure
   - PostgreSQL trigger for pruning (5-3) — atomic, reliable, zero-maintenance
   - Inline concurrency limiter (5-3) — 23 lines vs npm package, no external dependency
   - Service client pattern (5-1) — clean 4th factory for background jobs
5. **Foundation compound returns continue accelerating** — Stories 5-1/5-2/5-3 built the pipeline; Stories 5-4 through 5-8 reused those foundations progressively faster. Last 4 stories had zero scope additions.
6. **Test growth 1309 → 1532** (17% increase, 28 new test files). Comprehensive coverage across all layers.
7. **Zero production incidents, zero regressions** — 5 epics running, zero incidents total across entire project
8. **Bundle budget maintained throughout** — admin/analytics: 206.3 KB / 350 KB (59% of budget)
9. **Story preparation quality improved over the epic** — Previous Story Intelligence section carries forward patterns and gotchas. Scope additions: 3→4→2→1→0→0→0→0 (decreasing trend)
10. **Security consistently strong** — `CRON_SECRET` auth, RLS policies, `server-only` imports, `escapeHtml()` for email templates, admin auth guards on all API routes

---

## Challenges & Growth Areas

### 1. `systems` Table Schema Cascade (HIGH IMPACT)

Every new column on the `systems` table cascades to 15-20 files: `SYSTEM_SELECT_COLUMNS`, `DASHBOARD_SELECT`, `systemSchema`, `SystemHealthSummary`, `createMockSystem()`, `SYSTEM_DEFAULTS`, and every inline mock object across guardrails and unit tests.

**Occurrences:**
- Story 5-2: Added `consecutive_failures` — estimated 2-file blast radius, actual 8 files (4x underestimate)
- Story 5-7: Added `check_interval`, `timeout_threshold`, `failure_threshold` — cascaded to ~20 files including ~38 test failures from missing fields

**Root cause:** `systems` table is denormalized with 18+ columns spanning display, health, config, and branding concerns. Mock data must satisfy the full shape everywhere. Guardrails tests and inline mocks bypass the factory.

**Impact:** Significant developer time spent on mechanical mock updates rather than feature work. Blast radius consistently 3-4x underestimated in story planning.

### 2. OKLCH Color Mismatch with Recharts (MEDIUM IMPACT)

`hsl(var(--primary))` wrapping OKLCH CSS variable values produces broken colors in Recharts components.

**Occurrences:**
- Story 5-4 (M3): Tooltip border + Bar fill colors — `hsl(var(--border))` and `hsl(var(--primary))`
- Story 5-8 (H1): AreaChart stroke + CustomDot fill — `hsl(var(--destructive))`

**Root cause:** Recharts documentation and examples universally use `hsl()` wrappers. Our Tailwind v4 theme uses OKLCH values in CSS custom properties. Devs copy Recharts examples verbatim without awareness of the color space mismatch.

**Impact:** Visual bugs caught only in code review. Same pattern repeated across 2 stories despite the fix in 5-4.

### 3. XSS in Server-Side Email Templates (MEDIUM IMPACT)

Story 5-6 (M1): System names interpolated directly into HTML email body without escaping. Could enable HTML injection via crafted system names.

**Root cause:** First non-React HTML generation in the project. React auto-escapes JSX, but raw string template literals don't. No established pattern or security check for server-side HTML generation.

**Impact:** Fixed with `escapeHtml()` utility. Code review caught it, but no automated check exists.

### 4. Local Supabase Unavailability (LOW IMPACT)

Stories 5-2 and 5-6 required manual `database.ts` type updates because local Supabase wasn't running for `npm run db:types`.

**Root cause:** Local development environment setup — `supabase start` not consistently available.

**Impact:** Manual type edits can drift from actual migrations. Mitigated by type-check verification, but introduces risk.

---

## Key Insights & Learnings

1. **System-level enforcement works.** P1 story splitting, P2 mutateAsync, P3 contract verification all hit 100% compliance because they're embedded in story templates as `<!-- THRESHOLD CHECK -->` and `<!-- P3 -->` comments. Verbal agreements don't stick; template automation does.

2. **Novelty drives defect density.** First-time patterns (Resend email in 5-6, Recharts in 5-4) produce more code review issues than stories using established patterns (5-5, 5-7, 5-8). Budget extra review time for stories introducing new technologies.

3. **Denormalized entities create cascading maintenance costs.** The `systems` table at 18+ columns means every schema change touches 15-20 files. Centralizing mock data through factories (not inline objects) is the primary mitigation.

4. **Architecture simplification wins.** Supabase Realtime eliminated an entire custom WebSocket server. PostgreSQL triggers eliminated a cleanup cron. The inline concurrency limiter eliminated an npm dependency. Always ask: "what can we eliminate?"

5. **Story preparation quality improves over an epic.** The Previous Story Intelligence section in story files carries forward exact patterns and gotchas. Scope additions dropped from 3-4 in early stories to zero in the final 4 stories.

6. **Peak defect density is measurable and improvable.** Epic 4 peak: 20 issues/story. Epic 5 peak: 10 issues/story. The story splitting threshold (P1) is the primary driver — smaller stories = fewer integration seams = fewer defects.

---

## Previous Retrospective Follow-Through

### Epic 4 Retro Action Items Assessment

| # | Action Item | Status | Evidence in Epic 5 |
|---|-------------|--------|--------------------|
| P1 | Story splitting: 12+ tasks must be split | ✅ **Fully effective** | ALL 8 stories had `<!-- THRESHOLD CHECK -->` comments. Largest: 10 tasks. Zero exceeded threshold. |
| P2 | `mutateAsync` + try/catch mandatory | ✅ **Fully effective** | Applied in 5-6 NotificationSettings, 5-7 HealthConfigDialog. Zero unhandled promise rejection issues in any code review. |
| P3 | Integration contract verification | ✅ **Fully effective** | Stories 5-5, 5-6, 5-7, 5-8 all had explicit `<!-- P3 -->` contract verification checkboxes. Zero integration seam failures. |
| D1 | Fix flaky `preview/route.test.ts` timeout | ✅ Already resolved | Zero timeout issues across entire Epic 5. Static imports enforced. |
| D2 | `glow-pulse` keyframe hardcoded | ✅ Accepted | No revisit needed. |
| D3 | 30-day soft-delete cleanup | ⏳ Deferred | Still Epic 7 scope. Story 6-4 references it. |

**Score: 5/5 actionable items fully applied (D3 deferred by design)**

### Lessons Applied Successfully
- Story splitting threshold eliminated 12+ task stories entirely — peak defect density halved
- `mutateAsync` + try/catch pattern applied consistently — zero unhandled rejection issues
- Integration contract verification caught zero seam failures (prevention, not detection)
- Static imports enforced — zero test timeout issues
- Previous Story Intelligence section improved story preparation quality over the epic

### Missed Opportunities
- OKLCH color pattern from 5-4 fix was not documented as a project guideline — recurred in 5-8
- `escapeHtml()` pattern from 5-6 fix was not added to security checklist — should be preventive, not reactive

---

## Next Epic Preview — Epic 6: User Management & Administration

### Overview

5 stories covering CMS user account management: create accounts, assign/change roles, reset passwords, disable/delete accounts, login history tracking. Builds primarily on Epic 2 (Authentication) infrastructure.

### Stories

| Story | Description |
|-------|-------------|
| 6-1 | Create CMS user accounts (Super Admin creates for DxT Team) |
| 6-2 | Assign & change user roles (Super Admin, Admin, User) |
| 6-3 | Reset user passwords |
| 6-4 | Disable & delete user accounts (soft-delete, 30-day GDPR) |
| 6-5 | User login history & activity tracking |

### Dependencies on Epic 5

**Minimal.** Epic 6 builds on:
- Supabase Auth infrastructure (Epic 2) — all user CRUD via Supabase Auth
- Admin panel layout/sidebar (Epic 3) — new `/admin/users` page
- React Query patterns (Epic 4) — admin mutations/queries
- RBAC enforcement (Epic 2) — Super Admin role gates all user management
- `createServiceClient()` pattern (Epic 5, Story 5-1) — needed for Auth Admin API calls

### Watch Items

- **Supabase Auth Admin API:** First use of `supabase.auth.admin.*` APIs — createUser, updateUserById, deleteUser, listUsers. Needs research during story creation.
- **Story 6-4 (Disable & Delete):** Soft-delete with 30-day GDPR grace period. D3 (automated cleanup cron) is deferred to Epic 7 — Story 6-4 implements the mechanism, not the automation.
- **Story 6-5 (Login History):** Auth event tracking — hooking into `auth.onAuthStateChange()` or Supabase Auth hooks.

### No Significant Discoveries

Epic 5 did not reveal any findings that require changing Epic 6's plan. The direction is sound.

---

## Action Items

### Process Improvements

| # | Action | Owner | Success Criteria |
|---|--------|-------|-----------------|
| P1 | ✅ Document OKLCH + Recharts color pattern: "Use `var(--x)` NOT `hsl(var(--x))` for Recharts color props" — added as Gotcha #6 in `tailwind-v4-runtime-theming.md` | Dev (Amelia) | Zero OKLCH color bugs in Epic 6+ |
| P2 | ✅ Add `escapeHtml()` usage guideline for any non-React HTML generation (email templates, PDF, etc.) — added to `security-pre-review-checklist.md` Section 1 + reference table | Dev (Amelia) | Documented in security-pre-review-checklist.md |

### Technical Debt

| # | Item | Priority | Notes |
|---|------|----------|-------|
| D1 | ✅ `systems` table mock cascade — added `createMockSystemDb()` + `SystemDb` type to factory, refactored 6 HIGH-priority test files. 4 MEDIUM files skipped (partial shapes, no cascade risk). | MEDIUM | Blast radius reduced from ~20 files to 1-2 files for full System shape changes |
| D2 | `check_interval` column stored but not consumed by cron — per-system scheduling not enforced | LOW | Acceptable for MVP. Vercel Cron is global. Document as known limitation. |
| D3 | 30-day soft-delete cleanup cron | DEFERRED | Epic 7 scope (carried from Epic 3 → 4 → 5). Story 6-4 implements mechanism, Epic 7 adds automation. |

### Documentation

| # | Item | Owner |
|---|------|-------|
| DOC1 | ✅ OKLCH + Recharts color pattern (with P1) — Gotcha #6 in `tailwind-v4-runtime-theming.md` | Dev (Amelia) |
| DOC2 | ✅ `escapeHtml()` for server-side HTML — added to `security-pre-review-checklist.md` (with P2) | Dev (Amelia) |

### Team Agreements

**Continuing from previous epics:**
- Stories with 12+ tasks must be split before dev begins
- `mutateAsync` always wrapped in try/catch — no exceptions
- Integration contracts verified explicitly when story spans migration + app code
- Scope additions documented in real-time
- `npm run story-metrics` mandatory before marking review
- `npm run shadcn:verify` after any shadcn component install

**New for Epic 6:**
- Recharts color props use `var(--x)` directly — never `hsl(var(--x))`
- Any non-React HTML generation must use `escapeHtml()` for interpolated values

---

## Readiness Assessment

| Area | Status |
|------|--------|
| Testing & Quality | ✅ 1532 tests across 135 files, all passing, 0 regressions |
| Deployment | ✅ Live on Vercel production |
| Stakeholder Acceptance | ✅ All 8 stories reviewed and approved |
| Technical Health | ✅ Clean architecture, bundle within budget (206.3 KB / 350 KB) |
| Unresolved Blockers | ✅ None (D3 deferred by design) |
| Bundle Budget | ✅ All routes within budget |

**Verdict:** Epic 5 is fully complete. No blockers for Epic 6.

---

## Next Steps

1. ~~**Execute action items P1, P2**~~ — ✅ Done. OKLCH pattern added to `tailwind-v4-runtime-theming.md`, escapeHtml added to `security-pre-review-checklist.md`
2. **Begin Epic 6** — Start creating stories with SM agent's `create-story`
3. **Apply team agreements** from this retrospective immediately
4. **Research Supabase Auth Admin API** during Story 6-1 creation

---

## Team Performance

Epic 5 delivered 8 stories covering the complete health monitoring and analytics feature set with 223 new tests (1309 → 1532). The retrospective surfaced 6 key insights and identified the `systems` table schema cascade as the primary maintenance challenge. Epic 4 retro follow-through scored 5/5 — the second consecutive epic with near-perfect action item completion. Peak defect density was halved (20 → 10 issues/story) driven by story splitting enforcement. The team is well-positioned for Epic 6 with strong infrastructure, proven patterns, and clear action items for further improvement.

---

**Retrospective Status:** Complete
**Document saved:** `_bmad-output/implementation-artifacts/epic-5-retro-2026-02-08.md`
