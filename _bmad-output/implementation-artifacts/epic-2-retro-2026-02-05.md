# Epic 2 Retrospective — Authentication & Access Control

**Date:** 2026-02-05
**Facilitator:** Bob (Scrum Master)
**Epic:** Epic 2 — Authentication & Access Control (6 stories)
**Status:** Complete (6/6 stories done)

---

## Team Participants

- Alice (Product Owner)
- Bob (Scrum Master — facilitating)
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- Jiraw (Project Lead)

---

## Epic Summary & Metrics

### Delivery

- **Stories Completed:** 6/6 (100%)
  - 2-1: Initial Super Admin Account & Login
  - 2-2: TOTP MFA Setup
  - 2-3: Backup Codes Generation & Usage
  - 2-4: MFA Login Verification
  - 2-5: Secure Logout
  - 2-6: Route Protection & RBAC Enforcement
- **All stories:** Implemented, code reviewed, fixes applied, marked done
- **FRs covered:** FR1, FR2, FR3, FR4, FR5, FR6, FR7, FR8

### Quality

- **Test suite growth:** 96 (Epic 1 baseline) → 415 (+319 new tests)
- **Test files:** 50 total
- **Code review issues found:** ~47 total
  - Story 2.1: 8 issues (2 HIGH, 4 MEDIUM, 2 LOW)
  - Story 2.2: ~10 issues (4 HIGH, 3 MEDIUM, 3 LOW)
  - Story 2.3: 9 issues (3 HIGH, 4 MEDIUM, 2 LOW)
  - Story 2.4: 8 issues (3 HIGH, 2 MEDIUM, 3 LOW)
  - Story 2.5: 5 issues (1 HIGH, 4 MEDIUM)
  - Story 2.6: 7 issues (3 HIGH, 3 MEDIUM, 1 LOW)
- **All ~47 issues:** Fixed before marking stories done
- **HIGH severity issues:** ~16 (all security-related)
- **Production incidents:** 0
- **Regressions:** 0

### Business Outcomes

- Complete login flow with email/password + TOTP MFA
- Backup codes for MFA recovery (custom implementation — Supabase has no native support)
- Secure logout with global session revocation
- 3-layer defense: proxy.ts (session refresh) + Server Layout Guards (RBAC) + RLS (database)
- RBAC enforcement: Super Admin > Admin > User hierarchy
- CSP hardened: frame-ancestors, object-src, base-uri, form-action, Permissions-Policy
- Rate limiting on auth endpoints via Upstash Redis
- 4 Supabase client factories: server.ts, client.ts, proxy.ts (no middleware.ts)

---

## Successes & Strengths

1. **100% story completion** — all 6 stories delivered, reviewed, and done with zero regressions
2. **Massive test growth** — 319 new tests (96 → 415), 50 test files, jest-axe accessibility on every story
3. **Excellent code reuse** — Stories 2.4-2.6 heavily reused existing components, actions, schemas, and rate limiters. Story 2.4 was mostly wiring together existing pieces.
4. **Custom backup code system** — built from scratch when Supabase had no native support. Proper security: SHA-256 hashing, rate limiting, single-use enforcement, case-insensitive format tolerance
5. **3-layer defense architecture** — proxy.ts + layout guards + RLS implemented cleanly with clear separation of concerns
6. **Cross-story intelligence transfer** — every story carried forward learnings via "Previous Story Intelligence" sections. 16 documented architecture constraints applied consistently.
7. **Epic 1 retro follow-through** — 6/8 action items completed. Tech version drift completely eliminated.
8. **CSP hardening** — Story 2.6 significantly tightened Content Security Policy and added Permissions-Policy header
9. **Deliberate security trade-offs** — backup code aal1 limitation, SHA-256 vs bcrypt for backup codes — all documented with clear reasoning

---

## Challenges & Growth Areas

### 1. Code Review Volume Unchanged (MEDIUM IMPACT)

~47 issues across 6 stories (~8 avg/story) — same average as Epic 1 (32 issues / 4 stories = 8 avg/story). While issue complexity increased (more security-focused), the volume did not decrease.

**Impact:** Code review remains a bottleneck. Recurring patterns that should be caught by automation are still caught by humans.

### 2. Touch Target Standard Evolution (MEDIUM IMPACT)

Touch target standard changed 3 times during Epic 2:
- Story 2.1: 24px (original shadcn/ui default)
- Story 2.1 CR: bumped to 32px (h-8 w-8)
- Story 2.5 CR: bumped to 44px (min-h-11) for WCAG 2.1 AA compliance

**Impact:** Inconsistency across stories. Earlier stories may have sub-44px touch targets that need retroactive fixes.

### 3. Recurring `dark:` Class Pattern (LOW IMPACT)

`dark:` classes from shadcn/ui components stripped in Stories 2.1 and 2.2, same pattern as Epic 1. Documented knowledge did not prevent recurrence.

**Impact:** Minor — caught in review each time. But demonstrates that documentation alone doesn't prevent issues.

### 4. Documentation Accuracy Issues (MEDIUM IMPACT)

File List and test count accuracy flagged in 3/6 stories:
- Story 2.3: missing mfa.test.ts in file list
- Story 2.5: wrong test count baseline (claimed 345, actual 356)
- Story 2.5: incorrect test delta claim

**Impact:** Erodes trust in story documentation. Makes it harder to verify completeness.

### 5. Deferred E2E Coverage for Authenticated Flows (LOW IMPACT)

Stories 2.2, 2.3, and 2.4 all deferred full authenticated E2E test coverage with TODO notes. E2E tests exist but are limited to unauthenticated redirect checks and accessibility audits.

**Impact:** Low for now — unit tests provide strong coverage. But authenticated E2E gaps should be addressed before Epic 7 (Security & Audit).

### 6. HIGH Severity Security Issues in Code Review (HIGH IMPACT)

16 HIGH severity issues across Epic 2, all security-related:
- Open redirect vulnerability (Story 2.1)
- Race condition in MFA enrollment (Story 2.2)
- Missing error checks on mutation operations (Story 2.3)
- Missing MFA AAL2 enforcement in API auth guard (Story 2.6)
- Missing Sentry CSP connect-src (Story 2.6)

**Impact:** These issues would have shipped to production without code review. Security-specific checks are needed earlier in the development process.

---

## Key Insights & Learnings

1. **Automation beats documentation.** Recurring issues (dark: classes, touch targets, file list accuracy) survived documented knowledge across two epics. Automated enforcement via linting rules, scripts, and component defaults is the only reliable prevention.

2. **Code reuse accelerates delivery.** Stories 2.4-2.6 leveraged existing components, actions, and schemas heavily — reducing new code, new bugs, and review surface area. Architecture that enables reuse pays compound dividends.

3. **Custom solutions can be done right under pressure.** The backup code system was an unplanned engineering challenge (Supabase gap). The team built it with proper security rather than cutting corners or deferring.

4. **Security issues need earlier detection.** 16 HIGH severity issues caught only in code review is too late. A security-focused pre-review checklist would catch open redirects, error handling gaps, race conditions, and AAL enforcement gaps before review.

5. **Previous retro follow-through is a force multiplier.** 6/8 Epic 1 action items completed. Tech version drift — Epic 1's biggest pain point (9 issues in Story 1.1) — was completely eliminated in Epic 2. Retrospectives work when commitments are honored.

6. **Standards must be concrete and codified.** "Accessibility" as a goal is vague. "All interactive elements use min-h-11 (44px)" is enforceable. The touch target evolution shows the cost of aspirational vs. specific standards.

---

## Previous Retrospective Follow-Through

### Epic 1 Retro Action Items Assessment

| # | Action Item | Status | Evidence |
|---|-------------|--------|----------|
| P1 | Verify technology versions before each epic | ✅ Completed | Every Story 2.x had 16 verified architecture constraints |
| P2 | File List validation in code review | ⏳ Partial | File Lists present but accuracy flagged in Stories 2.3, 2.5 |
| P3 | Enforce Zod `.parse()` at data boundaries | ✅ Completed | Pattern consistently applied across all stories |
| P4 | Accessibility checklist in story creation | ✅ Completed | focus-visible, aria-label, touch targets, jest-axe in every story |
| D1 | CSP headers permissive | ✅ Addressed | Story 2.6 hardened CSP significantly |
| D2 | Bundle size budget (200KB) | ⏳ Ongoing | Not specifically addressed in Epic 2 |
| DOC1 | Update architecture.md versions | ✅ Completed | Updated before Epic 2 started |
| DOC2 | Document proxy.ts patterns | ✅ Completed | Story 2.6 fully implemented and documented |

**Score: 6/8 completed, 2 in progress**

### Lessons Applied Successfully
- Tech version drift eliminated — zero occurrences in Epic 2
- Zod `.parse()` at all data boundaries — consistent pattern
- Accessibility as first-pass requirement — jest-axe in every story
- data-testid for E2E tests — applied consistently across all 6 stories
- Cross-story intelligence transfer — every story carried forward learnings

### Missed Opportunities
- File List accuracy still manual — automation deferred again
- Bundle size not actively monitored during Epic 2

---

## Next Epic Preview — Epic 3: System Portfolio Management

### Overview

8 stories covering CMS Admin Panel Layout, Add/Edit/Delete Systems, Reorder, Toggle Visibility, Logo Management, and Live Status Indicators. 16 FRs covered (FR15-20a, FR23, FR42-43, FR45-46, FR69-70, FR72-73).

### Dependencies on Epic 2

| Dependency | Status |
|---|---|
| Route protection (proxy.ts + layout guards) | ✅ Done |
| RBAC enforcement (Admin+ role) | ✅ Done |
| `requireAuth('admin')` guard | ✅ Ready |
| `requireApiAuth('admin')` for API routes | ✅ Ready |
| CSP headers and security hardening | ✅ Done |
| Supabase client factories (server, client, proxy) | ✅ Done |
| Rate limiting infrastructure | ✅ Done |

### New Capabilities Needed (Story 3.1 Scope)

- React Query provider setup for `/admin/` routes
- Admin layout with `error.tsx` boundary
- Toast notification system
- Confirmation dialog pattern
- Loading state and empty state components
- CMS testing patterns (optimistic UI, file upload, drag-and-drop)

### Concerns Identified

- React Query is a new dependency — never used in the project yet
- File upload infrastructure (logo management) needs research
- Drag-and-drop or reorder UI pattern selection
- 8 stories = largest epic so far (Epic 1: 4, Epic 2: 6)
- Testing optimistic UI updates and file uploads is new territory

---

## Action Items

### Process Improvements

| # | Action | Owner | Success Criteria | Status |
|---|--------|-------|-----------------|--------|
| P1 | Add ESLint rule to flag `dark:` classes automatically | Dev (Amelia) | Zero `dark:` class issues in Epic 3 code reviews | ✅ Done — `eslint-rules/no-dark-classes.mjs`, added as `local/no-dark-classes` in `eslint.config.mjs` |
| P2 | Codify touch target standard: all interactive elements min 44px (`min-h-11`). Add to shared Button/component defaults | Dev (Amelia) | No touch target issues in code reviews | ✅ Done — `min-h-11` added to Button base + Input. Removed sub-44px variants (`xs`, `icon-xs`). All sizes ≥ 44px |
| P3 | Create automated script to generate File List from `git diff` and test counts from Vitest JSON reporter | Dev (Amelia) | Documentation accuracy issues drop to zero | ✅ Done — `scripts/story-metrics.ts`, run via `npm run story-metrics` |
| P4 | Add security-focused pre-review checklist: open redirects, error handling gaps, race conditions, AAL enforcement | SM (Bob) + Dev (Amelia) | HIGH severity security issues caught before code review | ✅ Done — `_bmad-output/implementation-artifacts/security-pre-review-checklist.md` (8 sections, 30+ checks) |

### Technical Debt

| # | Item | Owner | Priority | Notes | Status |
|---|------|-------|----------|-------|--------|
| D1 | `unsafe-eval` / `unsafe-inline` in CSP | Dev (Amelia) | LOW | Next.js requirement — monitor for nonce-based CSP in future releases | ✅ Documented — monitoring comment added in `next.config.ts` |
| D2 | Bundle size budget (350KB gzip JS) | Dev (Amelia) | MEDIUM | Evaluate after Epic 3 — React Query adds ~15KB. CI fails at 200KB, keeping 350KB limit | ✅ Documented — evaluate post-Epic 3 |
| D3 | Backup code login remains at aal1 | Dev (Amelia) | MEDIUM | Supabase limitation — RBAC guard workaround in place. Revisit if Supabase adds support | ✅ Documented — comment added in `src/lib/auth/guard.ts` |
| D4 | No audit logging for auth events | Dev (Amelia) | DEFERRED | Epic 7 scope — Stories 7.1-7.3 | ⏳ Deferred to Epic 7 |

### Documentation

| # | Item | Owner | Status |
|---|------|-------|--------|
| DOC1 | Document React Query setup patterns for admin routes | Dev (Amelia) | ✅ Done — `_bmad-output/implementation-artifacts/react-query-patterns.md`. Also fixed: QueryProvider moved from root → admin layout, `useState` → `isServer` singleton pattern |
| DOC2 | Document CMS testing patterns (optimistic UI, file upload, drag-and-drop) | QA (Dana/Murat) | ✅ Done — `_bmad-output/implementation-artifacts/cms-testing-patterns.md` (3 patterns, shared utilities, common pitfalls) |

### Team Agreements

- All interactive elements use `min-h-11` (44px) — no exceptions
- `dark:` classes are banned — enforce via automation, not review
- Security checklist reviewed BEFORE submitting to code review
- Story 3.1 establishes all CMS UI patterns (React Query, toasts, dialogs, loading/empty states) — subsequent stories reuse, not reinvent
- File Lists and test counts verified via automated tooling

---

## Significant Change Detection

**Epic Update Required:** NO

No discoveries from Epic 2 fundamentally change Epic 3's plan. The authentication and RBAC foundation is solid. All dependencies are met. The architecture holds. Epic 3 can proceed as planned.

---

## Readiness Assessment

| Area | Status |
|------|--------|
| Testing & Quality | ✅ 415 tests, all passing, 0 regressions |
| Deployment | ✅ Live in production |
| Stakeholder Acceptance | ✅ Confirmed by Jiraw |
| Technical Health | ✅ Solid — 3-layer defense, CSP hardened, zero fragility concerns |
| Unresolved Blockers | ✅ None blocking Epic 3 |

**Verdict:** Epic 2 is fully complete. Team is clear to proceed to Epic 3. No preparation sprint needed — Story 3.1 absorbs infrastructure setup.

---

## Next Steps

1. ~~Implement P1-P4 process improvements~~ — ✅ All done (ESLint rule, 44px standard, story-metrics script, security checklist)
2. Begin Epic 3 with Story 3.1: CMS Admin Panel Layout & Navigation
3. Story 3.1 establishes all CMS patterns (React Query, toasts, dialogs, states)
4. Review action items when creating Epic 3 stories
5. ~~Apply team agreements from this retrospective immediately~~ — ✅ Enforced via automation

---

## Team Performance

Epic 2 delivered 6 stories covering the entire authentication and access control system with 319 new tests (96 → 415). The retrospective surfaced 6 key insights and 0 significant discoveries requiring plan changes. The team is well-positioned for Epic 3 success.

---

**Retrospective Status:** Complete
**Document saved:** `_bmad-output/implementation-artifacts/epic-2-retro-2026-02-05.md`
