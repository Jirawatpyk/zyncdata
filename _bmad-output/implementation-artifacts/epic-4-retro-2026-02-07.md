# Epic 4 Retrospective — Content & Branding Management

**Date:** 2026-02-07
**Facilitator:** Bob (Scrum Master)
**Epic:** Epic 4 — Content & Branding Management (6 active stories + 1 deferred)
**Status:** Complete (6/6 active stories done, 4-5 deferred to Phase 2)

---

## Team Participants

- Alice (Product Owner)
- Bob (Scrum Master — facilitating)
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- Jiraw (Project Lead)

---

## Epic Summary & Metrics

### Delivery

- **Stories Completed:** 6/6 active (100%)
  - 4-A: Landing Page Pillars Section (Replace About/Intro)
  - 4-B: System Category Layers (Grouped Systems Display)
  - 4-1: Content Section Editor with WYSIWYG (Hero, Pillars, Footer)
  - 4-2: Theme & Branding Customization
  - 4-3: Preview Mode (Client-Side)
  - 4-4: Publish Changes (Draft/Publish Workflow)
- **Deferred:** 4-5 Content Version History & Restore — Phase 2 (FR74 excluded from MVP per PRD)
- **FRs covered:** FR24, FR25, FR26, FR27, FR28, FR29, FR30, FR31, FR32, FR68, FR71 (11 FRs)
- **All stories:** Implemented, code reviewed, fixes applied, marked done

### Quality

- **Test suite growth:** 986 (Epic 3 baseline) → 1309+ (~323 new tests, 33% growth)
- **Test files:** 84 → 107+ (~23 new test files)
- **Code review issues found:** ~54 total
  - Story 4-A: 3 issues (0 HIGH)
  - Story 4-B: 7 issues (1 HIGH — optimistic update null bug)
  - Story 4-1: ~12 issues (0 HIGH — XSS, schema, a11y, logging)
  - Story 4-2: **20 issues** (5 HIGH — font switching, RLS pattern, silent rejection, unhandled promises, JPEG mismatch)
  - Story 4-3: 6 issues (1 HIGH — useMemo stabilization)
  - Story 4-4: 6 issues (0 HIGH)
- **All issues:** Fixed before marking stories done
- **HIGH severity issues:** 7 total (5 in Story 4-2 alone)
- **Production incidents:** 0
- **Regressions:** 0

### Business Outcomes

- Full CMS content editing (Hero, Pillars, Footer) with TipTap WYSIWYG editor
- Theme & branding customization (3 color schemes, 3 fonts, platform logo, favicon)
- Client-side preview mode with device-width simulation (375/768/1280px)
- Draft/publish workflow — immune to ISR leaks from external revalidatePath callers
- Landing page refreshed: 4-pillar cards section, system category tabs with grouped display
- Hero animations toned down for enterprise/premium visual consistency

### Technical Infrastructure Established

- TipTap WYSIWYG integration (111 KB lazy chunk, headless testing, StarterKit + Link + Placeholder extensions)
- Two-level CSS variable indirection for Tailwind v4 runtime theme switching
- Draft/publish architecture (Strategy B: draft_content column — immune to ISR leaks)
- iframe-based preview with POST API rendering + sandboxed isolation
- 3 Google fonts loaded via `next/font/google` with CSS variable switching (Nunito, Inter, Open Sans)
- Branding storage bucket (Supabase Storage) with platform logo + favicon upload
- Content API routes (GET all, PATCH section) with admin auth guard
- React Query content mutations with optimistic update + rollback + toast
- XSS sanitization pipeline (stripHtml + sanitizeHtml + protocol whitelist + attribute escaping)
- Content mock factories (Hero, Pillars, Footer, Theme, LandingPageContent)
- Shared PreviewButton + PublishButton admin components

---

## Successes & Strengths

1. **100% story completion (6/6 active)** — correctly deferred 4-5 to Phase 2, no scope inflation
2. **Epic 3 retro follow-through — 9/10 items effective (best ever)**
   - P1 shadcn:verify: caught `dark:` in tabs.tsx (4-B)
   - P2 story-metrics enforcement: **zero File List accuracy issues** (down from 4/8 in Epic 3)
   - P3 safe db:types: zero database.ts corruption
   - P4 scope additions: every story documents changes in real-time
   - D1 bundle budget: all routes within budget throughout
   - D2 TipTap spike: successfully integrated in 4-1
   - D3 mock factories: extended with 5 new content factories
   - DOC1 shadcn registry: referenced
   - DOC2 WYSIWYG testing: headless pattern fully applied
3. **CSS variable two-level indirection** — innovative pattern for Tailwind v4 runtime theming. `:root` runtime vars → `@theme inline` var() references → all utilities (text, bg, gradient, opacity) update automatically
4. **Strategy B draft/publish architecture** — thorough analysis of all `revalidatePath('/')` callers (health mutations every 5 min, systems mutations 7 places, branding mutations 2 places) led to choosing draft_content column over ISR-gated approach. Immune to external ISR busts.
5. **TipTap integration smooth thanks to D2 spike** — no surprises. 111 KB lazy, headless testing worked, React 19 compatible
6. **Foundation compound returns** — Story 4-1 patterns (content API, mutations, dialog editors) reused in 4-2, 4-3, 4-4. Later stories progressively faster.
7. **Test growth 986 → 1309+** (33% increase, 23 new test files). Headless TipTap tests, API guardrails, component tests, mutation tests.
8. **Zero production incidents, zero regressions** — 4 epics running, zero incidents total
9. **Children pattern for server/client boundary** (Story 4-B) — CategoryTabs `'use client'` handles tab state only, SystemCard grids are server-rendered children. Zero hydration cost for cards.
10. **Security depth consistently strong** — XSS sanitization, protocol whitelisting, sandboxed iframe, RLS policies, auth guards on all API routes

---

## Challenges & Growth Areas

### 1. Story 4-2 Size and Defect Density (HIGH IMPACT)

Story 4-2 (Theme & Branding) had **16 tasks** and produced **20 code review issues (5 HIGH)**. This is the most issues in any single story across all 4 epics.

**Root cause analysis:**
- **Story too large:** 16 tasks spanning CSS refactoring, storage bucket, 4 editor components, font loading, dynamic favicon, landing page theme application. Nearly a mini-epic.
- **Integration seam failures:** HIGHs clustered at points where multiple systems meet:
  - H1: `next/font` CSS vars + Tailwind `font-sans` + layout `style` override
  - H2: Migration RLS pattern vs corrected system-logos pattern
  - H5: Migration MIME types vs app validation MIME types
- **Missing defensive patterns:** H3 (no toast on rejection), H4 (mutateAsync without try/catch in 4 components)

**Comparison:** Stories with 7-11 tasks averaged 0.43-0.86 issues/task. Story 4-2 at 16 tasks hit 1.25 issues/task with 5 HIGHs.

**Impact:** Code review caught everything (zero production issues), but relying on review as primary QA for fundamental features (font switching) is fragile.

### 2. Unhandled Promise Rejections Pattern (MEDIUM IMPACT)

`mutateAsync` calls without try/catch appeared in **4 components** in Story 4-2 (ColorSchemeEditor, FontSelector, LogoUploader, FaviconUploader). This is a missing guideline, not a one-off mistake.

**Impact:** Unhandled rejections in production could cause silent failures with no user feedback.

### 3. Integration Contract Mismatches (MEDIUM IMPACT)

When stories span migration files + application validation:
- Story 4-2 H2: RLS policy used `::text` cast instead of `(select ...)` subquery pattern
- Story 4-2 H5: Migration allowed JPEG, app rejected JPEG
- Story 4-B H1: Optimistic update used `?? s.category` instead of `!== undefined` guard

**Impact:** Each mismatch required code review to catch. No automated verification exists.

### 4. Pre-existing Flaky Test (LOW IMPACT)

`preview/route.test.ts` times out in full test suite but passes in isolation. Likely a test isolation issue (port conflict or async cleanup).

**Impact:** Could mask real failures in CI. Should fix early in Epic 5.

---

## Key Insights & Learnings

1. **Story size drives defect density exponentially.** 16-task stories produce 5x more HIGHs than 7-task stories. The threshold for splitting should be ~12 tasks or 4+ architectural layers.

2. **Integration seams are the highest-risk failure points.** Where 3+ systems must agree on a contract (CSS + Tailwind + fonts, migration MIME + app MIME), explicit verification is needed — not just hoping the developer checked.

3. **Retro action items work when enforced at the system level.** P2 (story-metrics enforcement) went from "partially effective" in Epic 3 to "fully effective" in Epic 4 because it was made a `<critical>` gate in the workflow. P4 (scope additions) worked because the template includes the table. Automation > discipline.

4. **Foundation compound returns keep accelerating.** Each epic builds patterns that make the next stories faster. Story 4-4 reused patterns from 4-1, 4-2, 4-3, and Epic 3. Later epics benefit from this growing library of proven patterns.

5. **Thorough architecture analysis prevents catastrophic bugs.** Strategy B (draft/publish) came from systematically analyzing every `revalidatePath('/')` caller. Strategy C would have shipped with a fundamental flaw (external ISR busts publishing drafts). The analysis took time but was worth every minute.

6. **CSS variable indirection for Tailwind v4 is reusable knowledge.** `@theme inline` compiles to static values at build time. Runtime theming requires `:root` custom properties referenced via `var()` in `@theme inline`. This pattern applies to any Tailwind v4 project needing runtime theme switching.

---

## Previous Retrospective Follow-Through

### Epic 3 Retro Action Items Assessment

| # | Action Item | Status | Evidence in Epic 4 |
|---|-------------|--------|--------------------|
| P1 | `npm run shadcn:verify` post-install | ✅ Effective | Caught `dark:` in tabs.tsx (4-B). Select component clean in 4-1. |
| P2 | `story-metrics` enforcement (`<critical>` gate) | ✅ **Fully effective** | Zero File List accuracy issues across all 6 stories (was 4/8 in Epic 3). |
| P3 | Safe `npm run db:types` wrapper | ✅ Effective | Used for category column (4-B) and draft_content (4-4). Zero corruption. |
| P4 | Scope Additions table in template | ✅ Effective | Every story documents changes in real-time. 4 stories have entries. |
| D1 | Per-route bundle budget (`npm run size`) | ✅ Fully applied | All routes within budget throughout. Landing 242.6 KB, Admin ≤ 350 KB. |
| D2 | TipTap spike (111 KB lazy) | ✅ Successfully integrated | Story 4-1 used TipTap in production. Headless testing worked perfectly. |
| D3 | Shared mock factory | ✅ Extended | Added 5 content factories (Hero, Pillars, Footer, Theme, LandingPageContent). |
| D4 | 30-day soft-delete cleanup | ⏳ Deferred | Still Epic 7 scope. |
| DOC1 | shadcn component registry | ✅ Referenced | Select component documented per registry. |
| DOC2 | WYSIWYG testing patterns | ✅ Applied | Headless TipTap tests (9 tests), mock editor pattern in all component tests. |

**Score: 9/10 completed or effective, 1 deferred (D4)**

### Lessons Applied Successfully
- TipTap spike preparation eliminated all integration risk for Story 4-1
- Mock factories prevented cascade pain when adding theme fields
- story-metrics enforcement achieved zero File List issues (complete turnaround)
- shadcn:verify caught regressions immediately
- Bundle budget checks in every story — never exceeded

### Missed Opportunities
- None significant — this was the best retro follow-through to date

---

## Next Epic Preview — Epic 5: Health Monitoring & Analytics Dashboard

### Overview

8 stories covering health check infrastructure, real-time dashboards, notifications, configurable settings, and historical data. 2 stories already done (5-1, 5-2), 1 ready-for-dev (5-3), 5 in backlog (5-4 through 5-8). 13 FRs covered (FR33-FR41, FR64-FR67).

### Current State

| Story | Status | Description |
|-------|--------|-------------|
| 5-1 | done | Basic health check service & status updates |
| 5-2 | done | Failure detection, retry logic & recovery |
| 5-3 | ready-for-dev | Health check data pruning & scalability |
| 5-4 | backlog | Health monitoring dashboard |
| 5-5 | backlog | Real-time dashboard updates |
| 5-6 | backlog | Health check failure notifications |
| 5-7 | backlog | Configurable health check settings |
| 5-8 | backlog | Historical health check data |

### Dependencies on Epic 4

| Dependency | Status |
|---|---|
| CMS admin panel infrastructure (sidebar, layouts, patterns) | ✅ Done |
| React Query infrastructure | ✅ Done |
| API route patterns (auth guard, Zod, response format) | ✅ Done |
| Toast/dialog/loading/empty state patterns | ✅ Done |

### Watch Items

- **5-5 (Real-time updates):** Architecture decision needed — WebSocket/SSE vs polling. Research before dev.
- **5-8 (Historical data):** Chart library selection — run bundle spike (same rigor as TipTap D2) before committing.
- **5-4 (Dashboard):** New admin page with data visualization — may need new component patterns.

### No Significant Discoveries

Epic 4 did not reveal any findings that require changing Epic 5's plan. The direction is sound.

---

## Action Items

### Process Improvements

| # | Action | Owner | Success Criteria | Status |
|---|--------|-------|-----------------|--------|
| P1 | Story splitting threshold: stories with 12+ tasks or touching 4+ architectural layers must be split before dev begins | SM (Bob) | Zero stories with 12+ tasks in Epic 5 | ✅ Done — comment added to `create-story/template.md` Tasks section |
| P2 | Document `mutateAsync` + try/catch as mandatory pattern in react-query-patterns.md | Dev (Amelia) | Zero unhandled promise rejection issues in Epic 5 code reviews | ✅ Done — new section + Rule #7 in `react-query-patterns.md` |
| P3 | Integration contract verification: when a story spans migration + app validation, add explicit "verify contract" checklist item in story tasks | SM (Bob) | Zero integration seam failures in Epic 5 | ✅ Done — comment added to `create-story/template.md` Tasks section |

### Technical Debt

| # | Item | Priority | Notes | Status |
|---|------|----------|-------|--------|
| D1 | Fix flaky `preview/route.test.ts` timeout in full suite | MEDIUM | Passes in isolation, times out in full run | ⏳ Open |
| D2 | `glow-pulse` keyframe hardcoded hex (not CSS var) | LOW | Known limitation — CSS var() in @keyframes limited browser support. Accept. | ✅ Accepted |
| D3 | 30-day soft-delete cleanup | DEFERRED | Epic 7 scope (carried from Epic 3 D4) | ⏳ Deferred |

### Bug Fixes (Post-Retro)

| # | Item | Status |
|---|------|--------|
| BF1 | EditSystemDialog: logo-only update ไม่สามารถ save ได้ — form `isDirty` ไม่ track logo mutation → เพิ่ม `logoChanged` state | ✅ Fixed |
| BF2 | SystemsList: soft-delete มี backend recovery แต่ไม่มี UI → เพิ่ม Restore button + optimistic clear `deletedAt` | ✅ Fixed |
| BF3 | Preview ไม่โชว์ Google Fonts จริง — `srcDoc` iframe ไม่มี `@font-face` rules → เพิ่ม `<link>` Google Fonts ใน preview HTML + แก้ CSP `style-src` เพิ่ม `https://fonts.googleapis.com` | ✅ Fixed |

### Documentation

| # | Item | Owner | Status |
|---|------|-------|--------|
| DOC1 | Update react-query-patterns.md: add `mutateAsync` + try/catch pattern, toast on validation failure | Dev (Amelia) | ✅ Done (with P2) |
| DOC2 | Document CSS variable two-level indirection pattern for Tailwind v4 runtime theming | Dev (Amelia) | ✅ Done — `tailwind-v4-runtime-theming.md` |

### Team Agreements

- Stories with 12+ tasks must be split before dev begins
- `mutateAsync` always wrapped in try/catch — no exceptions
- Integration contracts verified explicitly when story spans migration + app code
- Scope additions documented in real-time (continuing from Epic 3 P4)
- `npm run story-metrics` mandatory before marking review (continuing from Epic 3 P2)
- `npm run shadcn:verify` after any shadcn component install (continuing from Epic 3 P1)

---

## Readiness Assessment

| Area | Status |
|------|--------|
| Testing & Quality | ✅ 1309+ tests, all passing, 0 regressions |
| Deployment | ✅ Live on Vercel production |
| Stakeholder Acceptance | ✅ All 6 stories reviewed and approved |
| Technical Health | ✅ Draft/publish, preview, theming all stable |
| Unresolved Blockers | ✅ None |
| Bundle Budget | ✅ All routes within budget |

**Verdict:** Epic 4 is fully complete. No blockers for Epic 5 continuation.

---

## Remaining Items

| # | Item | Priority |
|---|------|----------|
| D1 | Fix flaky `preview/route.test.ts` timeout in full suite | ✅ Fixed — converted `await import()` to static imports |
| D3 | 30-day soft-delete cleanup cron job | DEFERRED (Epic 7) |
| DOC2 | Document CSS variable two-level indirection for Tailwind v4 | ✅ Done — `tailwind-v4-runtime-theming.md` |

## Next Steps

1. **Continue Epic 5** — Story 5-3 is ready-for-dev, proceed with creation
2. **Fix D1 (flaky test)** — early in Epic 5 before it masks failures
3. **Complete DOC2** — document CSS var two-level indirection pattern
4. **Apply team agreements** from this retrospective immediately

---

## Team Performance

Epic 4 delivered 6 stories covering the complete CMS content and branding management feature set with 323+ new tests (986 → 1309+). The retrospective surfaced 4 key insights and identified story size as the primary driver of defect density. Epic 3 retro follow-through scored 9/10 — the best ever — demonstrating that the team's commitment to continuous improvement is genuine and effective. The team is well-positioned for Epic 5 success with strong infrastructure, proven patterns, and clear action items for further improvement.

---

**Retrospective Status:** Complete
**Document saved:** `_bmad-output/implementation-artifacts/epic-4-retro-2026-02-07.md`
