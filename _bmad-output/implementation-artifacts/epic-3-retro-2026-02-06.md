# Epic 3 Retrospective — System Portfolio Management

**Date:** 2026-02-06
**Facilitator:** Bob (Scrum Master)
**Epic:** Epic 3 — System Portfolio Management (8 stories)
**Status:** Complete (8/8 stories done)

---

## Team Participants

- Alice (Product Owner)
- Bob (Scrum Master — facilitating)
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- Jiraw (Project Lead)

---

## Epic Summary & Metrics

### Delivery

- **Stories Completed:** 8/8 (100%)
  - 3-1: CMS Admin Panel Layout & Navigation
  - 3-2: Add New System
  - 3-3: Edit System Information
  - 3-4: Delete System with Soft Delete
  - 3-5: Reorder Systems Display
  - 3-6: Toggle System Visibility
  - 3-7: System Logo Management
  - 3-8: Live Status Indicators on Landing Page
- **All stories:** Implemented, code reviewed, fixes applied, marked done
- **FRs covered:** FR15, FR16, FR17, FR18, FR19, FR20, FR20a, FR23, FR42, FR43, FR45, FR46, FR69, FR70, FR72, FR73 (16 FRs)
- **Largest epic to date:** 8 stories (Epic 1: 4, Epic 2: 6)

### Quality

- **Test suite growth:** 415 (Epic 2 baseline) → 983 (+568 new tests, 137% growth)
- **Test files:** 50 → 84 (+34 files)
- **Code review issues found:** ~40+ total
  - Story 3.1: 2 issues (0 HIGH)
  - Story 3.2: 3 issues (0 HIGH)
  - Story 3.3: ~3 issues (0 HIGH)
  - Story 3.4: 7 issues (3 HIGH — database.ts corruption, button.tsx shadcn overwrite, missing filter)
  - Story 3.5: 4 issues (0 HIGH)
  - Story 3.6: 2 issues (0 HIGH)
  - Story 3.7: 8 issues (0 Critical, 4 MEDIUM, 4 LOW)
  - Story 3.8: 8 issues (1 HIGH — database.ts not regenerated, 5 MEDIUM, 2 LOW)
- **All issues:** Fixed before marking stories done
- **HIGH severity issues:** ~4 (mostly tooling/infrastructure, not security)
- **Production incidents:** 0
- **Regressions:** 0
- **Guardrail tests:** Introduced from Story 3.4 onward — automated auth/validation regression tests

### Business Outcomes

- Complete CMS admin panel for system portfolio management
- Full CRUD lifecycle: Add, Edit, Delete (soft), Reorder, Toggle visibility
- Logo upload/replace/delete via Supabase Storage
- Live status indicators on landing page (ready for Epic 5 health check data)
- Soft delete with 30-day recovery path via Edit form
- Consistent UX patterns: confirmation dialogs, success/error toasts, loading states, empty states

### Technical Infrastructure Established

- 7 React Query mutation hooks with consistent optimistic update + rollback pattern
- Standardized API route pattern (auth guard → parse → Zod validate → mutate → respond)
- Supabase Storage integration (system-logos bucket, RLS policies)
- `next/image` with `remotePatterns` for dynamic logos
- Dedicated endpoints for specific operations (toggle, reorder, logo) vs monolithic PATCH
- Guardrail test pattern for auth and validation regression prevention

---

## Successes & Strengths

1. **100% story completion (8/8)** — largest epic to date, delivered with zero regressions and zero production incidents
2. **Foundation story compound returns** — Story 3.1 established all CMS patterns (React Query, toasts, dialogs, loading/empty states). Stories 3.2-3.8 reused these patterns, accelerating delivery significantly. Later stories (3.5, 3.6) were notably faster.
3. **Massive test growth** — 568 new tests (415 → 983), 34 new test files. Guardrail tests introduced from Story 3.4 onward.
4. **P2 (44px touch targets) completely eliminated an issue class** — zero touch target issues in any Epic 3 code review. Button/Input component defaults are the gold standard for retro action items.
5. **Elegant architectural decisions:**
   - Soft-delete: `enabled: false` + `deleted_at` together, with auto-clear recovery in `updateSystem()`
   - Move buttons over drag-and-drop (Story 3.5): zero dependencies, fully accessible, 50 LOC
   - Dedicated toggle endpoint (Story 3.6): clean separation from PATCH, no `deleted_at` side effects
   - Mixed static/dynamic logo support (Story 3.7): both `/logos/tinedy.svg` and Supabase URLs work
   - Native `Intl.RelativeTimeFormat` (Story 3.8): zero-dependency relative time display
6. **Cross-story intelligence transfer** — every story carried forward learnings via "Previous Story Intelligence" sections with documented architecture constraints
7. **Epic 2 retro follow-through** — 6/8 action items completed and effective (P1 dark: rule, P2 touch targets, P4 security checklist, DOC1 React Query patterns, DOC2 CMS testing patterns)
8. **Dev agent model upgrade** — Stories 3.7-3.8 used Claude Opus 4.6 (upgrade from Opus 4.5 in 3.1-3.6), smooth transition with no pattern breaks

---

## Challenges & Growth Areas

### 1. Bundle Size Breach (HIGH IMPACT)

Bundle size reached **397.81 KB gzip** — 47.81 KB over the 350 KB limit. This directly constrained architectural decisions:
- Story 3.5 could not use @dnd-kit (~25-30 KB) for drag-and-drop reordering
- Epic 4 requires TipTap WYSIWYG editor (~50-100 KB) which will push past 450 KB

**Impact:** Blocker for Epic 4. CI enforces the limit. Must resolve strategy before starting.

### 2. shadcn Component Install Regressions (MEDIUM IMPACT)

shadcn `npx shadcn@latest add` overwrites customized files, reintroducing `dark:` classes and removing project standards:
- Story 3.4: `button.tsx` overwritten — lost `min-h-11` touch targets + gained 7 `dark:` classes (HIGH)
- Story 3.8: `badge.tsx` installed with 3 `dark:` classes
- Story 3.2: Needed `ResizeObserver` polyfill for new Radix UI components

**Impact:** Each install creates potential regressions. ESLint catches `dark:` classes (P1 working), but `min-h-11` loss is only caught in manual code review.

### 3. File List Accuracy Still Inconsistent (MEDIUM IMPACT)

Despite `story-metrics.ts` script (P3 from Epic 2), File List accuracy was flagged in **4 out of 8 stories** (3.4, 3.6, 3.7, 3.8).

**Impact:** Tool exists but isn't enforced in the workflow. Automation without enforcement is just a suggestion.

### 4. `database.ts` Corruption from Type Generation (MEDIUM IMPACT)

Running `npx supabase gen types typescript --local` occasionally outputs garbage on line 1 of `database.ts`, breaking type-check and lint. Occurred in:
- Story 3.4: "Connecting to db 5432" console leak
- Story 3.8: File not regenerated at all in initial commit

**Impact:** Breaks CI. Caught in code review each time, but should be automated.

### 5. Schema Change Mock Cascade (LOW IMPACT)

Adding new columns (`deleted_at` in Story 3.4, `last_checked_at` in Story 3.8) required updating mock objects in **10-20+ test files**. Each file needed the new field added to mock data.

**Impact:** Mechanical, tedious work. Not a quality concern but a velocity drag.

### 6. Undocumented Scope Creep (LOW IMPACT)

Story 3.4 included unplanned changes not in the original task list:
- Duplicate-name inline error in AddSystemDialog and EditSystemDialog
- proxy.ts API route bypass fix
- Route restructuring to `(public)/` route group

**Impact:** Changes were necessary but undocumented until code review flagged them.

---

## Key Insights & Learnings

1. **Foundation stories create compound returns.** Story 3.1's investment in patterns (React Query hooks, API adapters, toast notifications, empty/loading states) made Stories 3.2-3.8 progressively faster. The team got better at applying established patterns with each story.

2. **Automation WITH enforcement > automation alone.** P2 (44px touch targets baked into component defaults) eliminated issues completely — zero mentions in any code review. P3 (story-metrics script) exists but wasn't enforced — File List accuracy still flagged in 4/8 stories. The difference: P2 required zero human discipline; P3 required humans to remember to run a tool.

3. **Boring, consistent patterns scale.** Every mutation hook, every API route, every dialog followed the same architecture. New engineers could predict exactly how a new feature would be structured. This is a competitive advantage.

4. **shadcn is a double-edged sword.** Great component library, but `npx shadcn@latest add` can silently regress project standards. Need a post-install verification process.

5. **Bundle size is a first-class architectural constraint.** It already forced design choices in Epic 3 (no DnD library) and will block Epic 4 (TipTap). This needs a strategic decision, not just a higher number.

6. **Dedicated endpoints beat overloaded endpoints.** Creating separate routes for toggle (`/api/systems/[id]/toggle`), reorder (`/api/systems/reorder`), and logo (`/api/systems/[id]/logo`) kept each operation clean with minimal schemas. Much better than cramming everything through PATCH `/api/systems/[id]`.

---

## Previous Retrospective Follow-Through

### Epic 2 Retro Action Items Assessment

| # | Action Item | Status | Evidence in Epic 3 |
|---|-------------|--------|--------------------|
| P1 | ESLint rule for `dark:` classes | ✅ Effective | Caught issues in Stories 3.4 and 3.8. Automation working as designed. |
| P2 | 44px touch targets in Button/Input defaults | ✅ **Best action item** | Zero touch target issues in ANY Epic 3 code review. Complete elimination. |
| P3 | story-metrics.ts script | ⚠️ Partially effective | Tool exists but File List flagged in 4/8 stories. Not enforced. |
| P4 | Security pre-review checklist | ✅ Effective | Story 3.8 explicitly evaluated all 8 sections. Fewer HIGH security issues. |
| D1 | CSP monitoring | ✅ No issues | CSP stable through Epic 3. |
| D2 | Bundle size 350KB limit | ❌ Breached | At 397.81 KB. Constrained Epic 3 architecture. Blocker for Epic 4. |
| D3 | Backup code aal1 documented | ✅ Done | No impact on Epic 3. |
| D4 | Audit logging deferred | ⏳ Deferred | Still Epic 7 scope. |
| DOC1 | React Query patterns doc | ✅ Fully applied | Every hook followed documented patterns consistently. |
| DOC2 | CMS testing patterns doc | ✅ Applied | Guardrail tests introduced from Story 3.4. |

**Score: 7/10 completed or effective, 1 partial, 1 breached, 1 deferred**

### Lessons Applied Successfully
- React Query patterns followed consistently across all 7 mutation hooks
- Guardrail tests added as a new standard starting Story 3.4
- Security checklist evaluated where relevant
- 44px touch targets — zero violations
- ESLint `dark:` rule caught every shadcn regression

### Missed Opportunities
- story-metrics script not enforced in workflow
- Bundle size limit breached without proactive mitigation
- No post-install shadcn verification process

---

## Next Epic Preview — Epic 4: Content & Branding Management

### Overview

4 stories (+ 1 deferred to Phase 2) covering WYSIWYG content editing with TipTap, theme/branding customization, preview mode, and publish workflow. 11 FRs covered (FR24-FR31, FR68, FR71). FR74 (Version History) deferred to Phase 2.

### Dependencies on Epic 3

| Dependency | Status |
|---|---|
| CMS admin panel layout (sidebar, header, navigation) | ✅ Done |
| React Query infrastructure (QueryProvider, hooks, adapter) | ✅ Done |
| API route patterns (auth guard, Zod validation, response format) | ✅ Done |
| Toast/dialog/loading/empty state patterns | ✅ Done |
| `next/image` with remotePatterns | ✅ Done |
| Supabase Storage integration | ✅ Done |

### New Capabilities Needed (Epic 4 Scope)

- TipTap WYSIWYG editor (significant bundle impact — ~50-100 KB)
- Color picker component (theme customization)
- Font selector component
- Client-side preview mode (iframe or CSS transforms)
- Publish workflow (staging → live content swap)
- Content serialization (TipTap JSON ↔ JSONB storage)

### Concerns Identified

- **Bundle size blocker:** 397 KB + TipTap (~50-100 KB) = 450-500 KB, far exceeding 350 KB limit
- **WYSIWYG testing complexity:** TipTap requires specialized testing approach for both unit and E2E
- **Preview architecture:** Client-side device preview is non-trivial (iframe vs CSS transform)
- **Content migration:** Current seed data format in `landing_page_content` JSONB may need adaptation for TipTap
- **TipTap SSR/RSC compatibility:** Rich text editors are typically client-only

---

## Action Items

### Process Improvements

| # | Action | Owner | Success Criteria |
|---|--------|-------|-----------------|
| P1 | ✅ Add post-install verification for shadcn: `npm run shadcn:verify` checks `dark:` classes + `min-h-11` integrity | Dev (Amelia) | Zero shadcn-related regressions in Epic 4 code reviews |
| P2 | Enforce story-metrics script: add to story template as mandatory step before marking done | SM (Bob) | File List accuracy issues drop to zero in Epic 4 |
| P3 | ✅ Add `database.ts` sanity check: `npm run db:types` now uses safe wrapper with backup/restore on corruption | Dev (Amelia) | Zero database.ts corruption issues |
| P4 | Document scope changes in real-time: when unplanned changes are needed, add "Scope Additions" section to story file immediately | SM (Bob) + Dev (Amelia) | Zero undocumented scope creep in code reviews |

### Technical Debt

| # | Item | Owner | Priority | Notes |
|---|------|-------|----------|-------|
| D1 | ✅ Bundle size resolved: replaced total-JS budget with per-route First Load JS budget (public ≤ 250 KB, admin ≤ 350 KB). All routes pass. `npm run size` | Dev (Amelia) + Jiraw | **RESOLVED** | Landing 242.6 KB, Admin/Systems 304.4 KB — headroom for TipTap |
| D2 | E2E authenticated test coverage limited | QA (Dana) | MEDIUM | Auth fixture exists but many tests still skipped |
| D3 | Schema change mock cascade (10-20+ files per new column) | Dev (Amelia) | LOW | Consider shared mock factory or test helper |
| D4 | No automated 30-day cleanup for soft-deleted systems | Dev (Amelia) | DEFERRED | Epic 7 scope |

### Documentation

| # | Item | Owner |
|---|------|-------|
| DOC1 | ✅ shadcn component registry + post-install checklist: `shadcn-component-registry.md` | Dev (Amelia) |
| DOC2 | Extend CMS testing patterns with WYSIWYG testing approach (post-TipTap spike) | QA (Dana) |

### Team Agreements

- `npm run story-metrics` is **mandatory** before marking any story done
- Any `npx shadcn@latest add` must be followed by lint + visual check of modified files
- Scope additions documented in real-time, not retroactively
- Bundle size strategy must be resolved before Epic 4 Story 4.1
- `database.ts` verified after every `supabase gen types` run

---

## Significant Change Detection

**Epic Update Required:** ✅ RESOLVED — Bundle size strategy completed

~~During Epic 3, the bundle reached 397.81 KB (over 350 KB limit).~~ **Resolved:** Replaced total-JS budget with per-route First Load JS measurement. Landing page = 242.6 KB (≤ 250 KB), Admin/Systems = 304.4 KB (≤ 350 KB). TipTap can be added via dynamic import without impacting any route budget.

**Required before Epic 4:**
1. ✅ ~~Resolve bundle size strategy~~ — Done. Per-route budgets via `npm run size`
2. Complete TipTap spike (bundle measurement, SSR/RSC compatibility, testing approach)
3. Update Epic 4 stories if alternative to TipTap is chosen

---

## Epic 4 Preparation Tasks

### Critical Path (Must complete before Epic 4)

| Task | Owner | Notes |
|------|-------|-------|
| ✅ ~~Bundle size audit + strategy decision~~ | Dev (Amelia) + Jiraw | Done — per-route budget, `npm run size` |
| TipTap spike: install, measure bundle, test SSR/RSC, prototype | Dev (Amelia) | Must confirm feasibility before Story 4.1 |

### Parallel Preparation (During early stories)

| Task | Owner | Notes |
|------|-------|-------|
| WYSIWYG testing patterns research | QA (Dana) | Vitest + Playwright approaches |
| Preview architecture decision (iframe vs CSS transform) | Dev (Amelia) | Story 4.3 needs this |
| `landing_page_content` schema review for TipTap compatibility | Dev (Amelia) | Verify JSONB format works |

### Nice-to-Have

| Task | Owner | Notes |
|------|-------|-------|
| TipTap accessibility audit (WCAG 2.1 AA) | Dev (Amelia) | Rich text a11y is complex |
| Content migration strategy (seed data → TipTap format) | Dev (Amelia) | May need migration script |

---

## Readiness Assessment

| Area | Status |
|------|--------|
| Testing & Quality | ✅ 983 tests, all passing, 0 regressions |
| Deployment | ✅ Live on Vercel production |
| Stakeholder Acceptance | ✅ All 8 stories reviewed and approved |
| Technical Health | ✅ Bundle resolved — per-route budgets, all routes pass |
| Unresolved Blockers | ⚠️ TipTap spike still needed before Epic 4 Story 4.1 |

**Verdict:** Epic 3 is fully complete. Team has 1 critical path item remaining (TipTap spike) before Epic 4 can begin.

---

## Next Steps

1. ✅ ~~Resolve bundle size strategy~~ — Done. Per-route First Load JS budgets.
2. **Complete TipTap spike** — Dev (Amelia) to prototype, measure bundle, test compatibility
3. **Begin Epic 4** with Story 4.1 once TipTap spike is clear
4. ✅ ~~Review action items~~ — P1, P3, D1, DOC1 completed
5. **Apply team agreements** from this retrospective immediately

---

## Team Performance

Epic 3 delivered 8 stories covering the entire system portfolio management feature with 568 new tests (415 → 983). The retrospective surfaced 6 key insights and 1 significant discovery (bundle size breach requiring strategy before Epic 4). The team established consistent patterns that accelerated delivery across the epic, with later stories completing noticeably faster than earlier ones. The team is well-positioned for Epic 4 success once the bundle strategy is resolved.

---

**Retrospective Status:** Complete
**Document saved:** `_bmad-output/implementation-artifacts/epic-3-retro-2026-02-06.md`
